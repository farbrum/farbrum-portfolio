import { useState } from 'react'
import { useProductStore } from '../store/productStore'
import { useAuthStore } from '../store/authStore'
import Window from '../components/Window'
import { Users, Plus, Trash2, Edit3, Calendar, Save, X, AlertTriangle, ChevronLeft, ChevronRight } from 'lucide-react'

const inp = "w-full h-9 px-3 bg-bg-input border border-white/10 rounded text-sm text-white placeholder:text-gray-600 focus:outline-none focus:ring-2 focus:ring-rose/30 focus:border-rose transition-all"
const lbl = "block text-[10px] font-semibold text-gray-500 uppercase tracking-wider mb-1"
const COMPETENCES = ['excavation','transport','pose','tuyauterie','collage','remblai','livraison']
const NOMS_MOIS = ['Janvier','F√©vrier','Mars','Avril','Mai','Juin','Juillet','Ao√ªt','Septembre','Octobre','Novembre','D√©cembre']

// Jours f√©ri√©s fran√ßais
function getJoursFeries(annee) {
  // P√¢ques (algorithme de Meeus)
  const a=annee%19,b=Math.floor(annee/100),c=annee%100
  const d=Math.floor(b/4),e=b%4,f=Math.floor((b+8)/25)
  const g=Math.floor((b-f+1)/3),h=(19*a+b-d-g+15)%30
  const i=Math.floor(c/4),k=c%4,l=(32+2*e+2*i-h-k)%7
  const m=Math.floor((a+11*h+22*l)/451)
  const mois=Math.floor((h+l-7*m+114)/31)-1, jour=(h+l-7*m+114)%31+1
  const paques = new Date(annee, mois, jour)
  const lundiPaques = new Date(paques); lundiPaques.setDate(paques.getDate()+1)
  const ascension = new Date(paques); ascension.setDate(paques.getDate()+39)
  const lundiPentecote = new Date(paques); lundiPentecote.setDate(paques.getDate()+50)
  const fmt = dt => dt.toISOString().split('T')[0]
  return [
    `${annee}-01-01`, // Jour de l'an
    fmt(lundiPaques),  // Lundi de P√¢ques
    `${annee}-05-01`, // F√™te du travail
    `${annee}-05-08`, // Victoire 1945
    fmt(ascension),    // Ascension
    fmt(lundiPentecote), // Lundi Pentec√¥te
    `${annee}-07-14`, // F√™te nationale
    `${annee}-08-15`, // Assomption
    `${annee}-11-01`, // Toussaint
    `${annee}-11-11`, // Armistice
    `${annee}-12-25`, // No√´l
  ]
}
const JOURS_COURT = ['Lu','Ma','Me','Je','Ve','Sa','Di']

// ===== Calendrier mensuel interactif =====
function AgendaCalendar({ indisponibilites = [], reservations = [], onToggle }) {
  const now = new Date()
  const [mois, setMois] = useState(now.getMonth())
  const [annee, setAnnee] = useState(now.getFullYear())

  const prevM = () => { if (mois === 0) { setMois(11); setAnnee(a => a - 1) } else setMois(m => m - 1) }
  const nextM = () => { if (mois === 11) { setMois(0); setAnnee(a => a + 1) } else setMois(m => m + 1) }

  const premierJour = new Date(annee, mois, 1).getDay()
  const offset = (premierJour + 6) % 7
  const nbJoursMois = new Date(annee, mois + 1, 0).getDate()
  const feries = getJoursFeries(annee)

  const cells = []
  for (let i = 0; i < offset; i++) cells.push(null)
  for (let d = 1; d <= nbJoursMois; d++) cells.push(d)

  const today = now.toISOString().split('T')[0]

  return (
    <div className="bg-black/20 rounded-lg p-3">
      {/* Header mois */}
      <div className="flex items-center justify-between mb-3">
        <button type="button" onClick={prevM} className="w-7 h-7 flex items-center justify-center rounded hover:bg-white/5 text-gray-400 hover:text-white transition-all">
          <ChevronLeft className="w-4 h-4" />
        </button>
        <span className="text-sm font-bold text-white">{NOMS_MOIS[mois]} {annee}</span>
        <button type="button" onClick={nextM} className="w-7 h-7 flex items-center justify-center rounded hover:bg-white/5 text-gray-400 hover:text-white transition-all">
          <ChevronRight className="w-4 h-4" />
        </button>
      </div>

      {/* Jours de la semaine */}
      <div className="grid grid-cols-7 gap-1 mb-1">
        {JOURS_COURT.map(j => (
          <div key={j} className="text-center text-[9px] font-bold text-gray-600 py-0.5">{j}</div>
        ))}
      </div>

      {/* Grille des jours */}
      <div className="grid grid-cols-7 gap-1">
        {cells.map((d, i) => {
          if (!d) return <div key={`e-${i}`} />

          const dateStr = `${annee}-${String(mois + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`
          const dow = new Date(annee, mois, d).getDay()
          const isDimanche = dow === 0
          const isSamedi = dow === 6
          const isFerie = feries.includes(dateStr) && !isDimanche
          const isInList = indisponibilites.includes(dateStr)
          // Samedi & f√©ri√©s : logique invers√©e ‚Äî indispo par d√©faut, dispo si dans la liste
          const isClosedDefault = isSamedi || isFerie
          const isIndispo = isClosedDefault ? !isInList : isInList
          const isReserve = (reservations || []).some(r => r.dates?.includes(dateStr))
          const isToday = dateStr === today
          const isPast = dateStr < today

          let bg = 'bg-emerald-500/15 hover:bg-emerald-500/25 text-emerald-400 cursor-pointer' // dispo
          if (isDimanche) bg = 'bg-white/3 text-gray-700 cursor-default'
          else if (isReserve) bg = 'bg-rose/25 text-rose cursor-default'
          else if (isClosedDefault && !isInList) bg = 'bg-red-500/15 hover:bg-red-500/25 text-red-400/60 cursor-pointer' // ferm√© par d√©faut
          else if (isClosedDefault && isInList) bg = 'bg-emerald-500/15 hover:bg-emerald-500/25 text-emerald-400 cursor-pointer' // ouvert par override
          else if (isIndispo) bg = 'bg-red-500/20 hover:bg-red-500/30 text-red-400 cursor-pointer'
          else if (isPast) bg = 'bg-white/3 text-gray-600 cursor-default'

          const handleClick = () => {
            if (isDimanche || isReserve) return // dimanche interdit, r√©servation aussi
            onToggle(dateStr)
          }

          return (
            <button
              key={dateStr}
              type="button"
              onClick={handleClick}
              disabled={isDimanche}
              className={`relative h-8 rounded text-[11px] font-medium transition-all ${bg} ${isToday ? 'ring-1 ring-white/40' : ''}`}
            >
              {d}
              {isFerie && <span className="absolute top-0 right-0.5 text-[6px]">üî¥</span>}
              {isReserve && <span className="absolute bottom-0.5 left-1/2 -translate-x-1/2 w-1 h-1 rounded-full bg-rose" />}
            </button>
          )
        })}
      </div>

      {/* L√©gende */}
      <div className="flex items-center gap-3 mt-3 pt-2 border-t border-white/5">
        <div className="flex items-center gap-1">
          <div className="w-3 h-3 rounded bg-emerald-500/20 border border-emerald-500/30" />
          <span className="text-[8px] text-gray-500">Disponible</span>
        </div>
        <div className="flex items-center gap-1">
          <div className="w-3 h-3 rounded bg-red-500/20 border border-red-500/30" />
          <span className="text-[8px] text-gray-500">Indisponible</span>
        </div>
        <div className="flex items-center gap-1">
          <div className="w-3 h-3 rounded bg-rose/25 border border-rose/40" />
          <span className="text-[8px] text-gray-500">R√©serv√© (chantier)</span>
        </div>
        <div className="flex items-center gap-1">
          <div className="w-3 h-3 rounded bg-red-500/15 border border-red-500/20" />
          <span className="text-[8px] text-gray-500">Sam. / F√©ri√© (indispo, clic pour ouvrir)</span>
        </div>
        <div className="flex items-center gap-1">
          <div className="w-3 h-3 rounded bg-white/5 border border-white/10" />
          <span className="text-[8px] text-gray-500">Dimanche (ferm√©)</span>
        </div>
      </div>
    </div>
  )
}

// ===== Formulaire cr√©ation/√©dition =====
function RessourceForm({ initial, onSave, onCancel }) {
  const [form, setForm] = useState(initial || {
    nom: '',
    role: 'pelleur',
    tarifJournalier: 280,
    tarifHoraire: 35,
    telephone: '',
    competences: ['excavation', 'pose'],
  })
  const set = (k, v) => setForm(f => ({ ...f, [k]: v }))
  const toggleComp = (c) => setForm(f => ({
    ...f,
    competences: f.competences.includes(c) ? f.competences.filter(x => x !== c) : [...f.competences, c]
  }))

  const ROLES = [
    { id: 'pelleur', nom: 'Pelleur / Conducteur engin' },
    { id: 'chauffeur', nom: 'Chauffeur PL / Tracteur' },
    { id: 'poseur', nom: 'Poseur / Tuyauteur' },
    { id: 'chef', nom: 'Chef de chantier' },
    { id: 'manoeuvre', nom: 'Man≈ìuvre' },
  ]

  return (
    <div className="space-y-3">
      <div className="grid grid-cols-2 gap-3">
        <div>
          <label className={lbl}>Nom complet</label>
          <input value={form.nom} onChange={e => set('nom', e.target.value)} className={inp} placeholder="Ex: Jean Dupont" />
        </div>
        <div>
          <label className={lbl}>R√¥le</label>
          <select value={form.role} onChange={e => set('role', e.target.value)} className={inp}>
            {ROLES.map(r => <option key={r.id} value={r.id}>{r.nom}</option>)}
          </select>
        </div>
      </div>

      <div className="grid grid-cols-3 gap-3">
        <div>
          <label className={lbl}>Tarif journalier (‚Ç¨)</label>
          <input type="number" value={form.tarifJournalier} onChange={e => set('tarifJournalier', parseFloat(e.target.value) || 0)} className={inp} />
        </div>
        <div>
          <label className={lbl}>Tarif horaire (‚Ç¨)</label>
          <input type="number" value={form.tarifHoraire} onChange={e => set('tarifHoraire', parseFloat(e.target.value) || 0)} className={inp} />
        </div>
        <div>
          <label className={lbl}>T√©l√©phone</label>
          <input value={form.telephone || ''} onChange={e => set('telephone', e.target.value)} className={inp} placeholder="06..." />
        </div>
      </div>

      <div>
        <label className={lbl}>Comp√©tences</label>
        <div className="flex flex-wrap gap-1.5">
          {COMPETENCES.map(c => (
            <button
              key={c}
              type="button"
              onClick={() => toggleComp(c)}
              className={`px-2.5 py-1 rounded text-[10px] font-semibold border transition-all ${
                form.competences.includes(c)
                  ? 'bg-rose/15 border-rose/30 text-rose'
                  : 'bg-bg-input border-white/10 text-gray-500 hover:border-white/20'
              }`}
            >
              {c}
            </button>
          ))}
        </div>
      </div>

      <div className="flex items-center justify-end gap-2 pt-2">
        <button type="button" onClick={onCancel} className="h-8 px-4 text-xs text-gray-500 hover:text-white hover:bg-white/5 rounded transition-all">
          <X className="w-3 h-3 inline mr-1" />Annuler
        </button>
        <button
          type="button"
          onClick={() => { if (!form.nom.trim()) return alert('Nom requis'); onSave(form) }}
          className="h-8 px-4 bg-rose text-white text-xs font-semibold rounded flex items-center gap-1.5"
        >
          <Save className="w-3 h-3" />Enregistrer
        </button>
      </div>
    </div>
  )
}

// ===== Carte ressource =====
function RessourceCard({ ressource, onEdit, onDelete, onSelectCalendar, isSelected }) {
  const nbIndispo = (ressource.indisponibilites || []).length
  const ROLE_LABELS = { pelleur: 'üöú Pelleur', chauffeur: 'üöõ Chauffeur', poseur: 'üîß Poseur', chef: 'üë∑ Chef', manoeuvre: 'üß§ Man≈ìuvre' }
  const ROLE_COLORS = { pelleur: 'text-amber-400', chauffeur: 'text-blue-400', poseur: 'text-emerald-400', chef: 'text-rose', manoeuvre: 'text-gray-300' }

  return (
    <div className={`border rounded-lg overflow-hidden transition-all ${isSelected ? 'border-rose/40 bg-rose/5' : 'border-white/5 bg-bg-card hover:border-white/10'}`}>
      <div className="p-3 flex items-start justify-between">
        <div className="flex-1 min-w-0">
          <div className="flex items-center gap-2 mb-1">
            <span className={`text-xs font-bold ${ROLE_COLORS[ressource.role] || 'text-white'}`}>
              {ROLE_LABELS[ressource.role] || ressource.role}
            </span>
          </div>
          <p className="text-sm font-medium text-white truncate">{ressource.nom}</p>
          <div className="flex items-center gap-3 mt-1.5">
            <span className="text-[10px] text-gray-500">üí∞ {ressource.tarifJournalier}‚Ç¨/jour</span>
            <span className="text-[10px] text-gray-500">‚è± {ressource.tarifHoraire}‚Ç¨/h</span>
            {ressource.telephone && <span className="text-[10px] text-gray-500">üì± {ressource.telephone}</span>}
          </div>
          <div className="flex flex-wrap gap-1 mt-2">
            {(ressource.competences || []).map(c => (
              <span key={c} className="px-1.5 py-0.5 bg-white/5 border border-white/10 rounded text-[8px] text-gray-400 font-medium">{c}</span>
            ))}
          </div>
        </div>

        <div className="flex items-center gap-1 ml-2 shrink-0">
          <button onClick={() => onSelectCalendar(ressource.id)}
            className={`w-7 h-7 rounded flex items-center justify-center transition-all ${isSelected ? 'bg-rose/20 text-rose' : 'bg-white/5 text-gray-500 hover:text-white hover:bg-white/10'}`}
            title="Agenda">
            <Calendar className="w-3.5 h-3.5" />
          </button>
          <button onClick={() => onEdit(ressource)}
            className="w-7 h-7 rounded flex items-center justify-center bg-white/5 text-gray-500 hover:text-white hover:bg-white/10 transition-all"
            title="Modifier">
            <Edit3 className="w-3.5 h-3.5" />
          </button>
          <button onClick={() => onDelete(ressource.id)}
            className="w-7 h-7 rounded flex items-center justify-center bg-white/5 text-red-500/50 hover:text-red-400 hover:bg-red-500/10 transition-all"
            title="Supprimer">
            <Trash2 className="w-3.5 h-3.5" />
          </button>
        </div>
      </div>

      {/* Barre de statut */}
      <div className="h-7 bg-black/20 border-t border-white/5 px-3 flex items-center justify-between">
        <span className="text-[9px] text-gray-600">
          {nbIndispo > 0 ? `${nbIndispo} jour${nbIndispo > 1 ? 's' : ''} bloqu√©${nbIndispo > 1 ? 's' : ''}` : '‚úÖ Aucune indisponibilit√©'}
        </span>
        {isSelected && <span className="text-[9px] text-rose font-bold">‚ñº Agenda ouvert</span>}
      </div>
    </div>
  )
}

// ===== Page principale =====
export default function Ressources() {
  const { user } = useAuthStore()
  const { ressources, addRessource, updateRessource, deleteRessource, toggleRessourceIndispo } = useProductStore()
  const [mode, setMode] = useState('list') // list | add | edit
  const [editTarget, setEditTarget] = useState(null)
  const [selectedCalId, setSelectedCalId] = useState(null)

  if (user?.role !== 'admin') {
    return (
      <Window title="Acc√®s refus√©">
        <div className="p-8 text-center">
          <AlertTriangle className="w-10 h-10 text-amber-400 mx-auto mb-2" />
          <p className="text-sm text-gray-400">R√©serv√© aux administrateurs.</p>
        </div>
      </Window>
    )
  }

  const resList = ressources || []
  const selectedRess = selectedCalId ? resList.find(r => r.id === selectedCalId) : null

  const handleAdd = (data) => {
    addRessource(data)
    setMode('list')
  }

  const handleEdit = (data) => {
    if (editTarget) {
      updateRessource(editTarget.id, data)
    }
    setMode('list')
    setEditTarget(null)
  }

  const handleDelete = (id) => {
    if (confirm('Supprimer cette ressource ?')) {
      deleteRessource(id)
      if (selectedCalId === id) setSelectedCalId(null)
    }
  }

  const handleStartEdit = (r) => {
    setEditTarget(r)
    setMode('edit')
  }

  const handleToggleCal = (id) => {
    setSelectedCalId(prev => prev === id ? null : id)
  }

  return (
    <div className="space-y-4">
      <div className="flex items-center justify-between">
        <h1 className="font-display text-xl font-bold text-white flex items-center gap-2">
          <Users className="w-5 h-5 text-rose" /> Ressources humaines
        </h1>
        {mode === 'list' && (
          <button onClick={() => setMode('add')}
            className="h-8 px-4 bg-rose text-white text-xs font-semibold rounded flex items-center gap-1.5 shadow-[0_0_12px_rgba(200,80,155,0.2)]">
            <Plus className="w-3.5 h-3.5" /> Ajouter
          </button>
        )}
      </div>

      {/* R√©sum√© */}
      <div className="grid grid-cols-4 gap-3">
        {[
          { l: 'Total', v: resList.length, c: 'text-rose' },
          { l: 'Pelleurs', v: resList.filter(r => r.role === 'pelleur').length, c: 'text-amber-400' },
          { l: 'Chauffeurs', v: resList.filter(r => r.role === 'chauffeur').length, c: 'text-blue-400' },
          { l: 'Poseurs', v: resList.filter(r => r.role === 'poseur' || r.role === 'manoeuvre' || r.role === 'chef').length, c: 'text-emerald-400' },
        ].map(s => (
          <div key={s.l} className="bg-bg-card border border-white/5 rounded-lg p-3 text-center">
            <p className={`text-2xl font-bold ${s.c}`}>{s.v}</p>
            <p className="text-[9px] text-gray-500 uppercase">{s.l}</p>
          </div>
        ))}
      </div>

      {/* Formulaire ajout */}
      {mode === 'add' && (
        <Window title="‚ûï Nouvelle ressource">
          <div className="p-5">
            <RessourceForm onSave={handleAdd} onCancel={() => setMode('list')} />
          </div>
        </Window>
      )}

      {/* Formulaire √©dition */}
      {mode === 'edit' && editTarget && (
        <Window title={`‚úèÔ∏è Modifier : ${editTarget.nom}`}>
          <div className="p-5">
            <RessourceForm
              initial={editTarget}
              onSave={handleEdit}
              onCancel={() => { setMode('list'); setEditTarget(null) }}
            />
          </div>
        </Window>
      )}

      {/* Liste des ressources */}
      <div className="grid md:grid-cols-2 gap-3">
        {resList.map(r => (
          <RessourceCard
            key={r.id}
            ressource={r}
            onEdit={handleStartEdit}
            onDelete={handleDelete}
            onSelectCalendar={handleToggleCal}
            isSelected={selectedCalId === r.id}
          />
        ))}
        {resList.length === 0 && (
          <div className="col-span-2 text-center py-12">
            <Users className="w-12 h-12 text-gray-700 mx-auto mb-3" />
            <p className="text-sm text-gray-500">Aucune ressource humaine enregistr√©e</p>
            <p className="text-[10px] text-gray-600 mt-1">Cliquez "Ajouter" pour cr√©er votre premier ouvrier</p>
          </div>
        )}
      </div>

      {/* Calendrier de la ressource s√©lectionn√©e */}
      {selectedRess && (
        <Window title={`üìÖ Agenda de ${selectedRess.nom}`}>
          <div className="p-5">
            <div className="mb-3 p-2.5 bg-rose/5 border border-rose/15 rounded">
              <p className="text-[10px] text-gray-400">
                üëÜ <strong className="text-rose">Cliquez sur un jour</strong> pour basculer entre disponible (vert) et indisponible (rouge). 
                Les dimanches sont ferm√©s. Les samedis et jours f√©ri√©s sont indisponibles par d√©faut (cliquez pour les ouvrir). Les jours r√©serv√©s par un chantier apparaissent en rose.
              </p>
            </div>
            <AgendaCalendar
              indisponibilites={selectedRess.indisponibilites || []}
              reservations={[]} // TODO: sera rempli quand on liera les devis
              onToggle={(dateStr) => toggleRessourceIndispo(selectedRess.id, dateStr)}
            />
            {(selectedRess.indisponibilites || []).length > 0 && (
              <div className="mt-3 p-2.5 bg-red-500/5 border border-red-500/15 rounded">
                <p className="text-[10px] text-gray-400 mb-1">üî¥ Jours indisponibles :</p>
                <div className="flex flex-wrap gap-1">
                  {[...(selectedRess.indisponibilites || [])].sort().map(d => (
                    <span key={d} className="px-1.5 py-0.5 bg-red-500/10 border border-red-500/20 rounded text-[9px] text-red-400">
                      {new Date(d + 'T12:00:00').toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' })}
                    </span>
                  ))}
                </div>
              </div>
            )}
          </div>
        </Window>
      )}
    </div>
  )
}
